import React, { useState, useEffect, useMemo } from 'react';
import { ChevronRight, ChevronDown, Loader2, Sparkles, Download, BarChart3, Table2, Grid3x3, Trash2, Users, DollarSign, AlertTriangle, Calendar, TrendingUp, Search, Filter, X, CheckCircle, Clock, Play, Pause, LogOut, Plus, ZoomIn, ZoomOut, Maximize2, Edit, Save } from 'lucide-react';
import './App.css';

// Firebase imports
import { db, auth } from './firebase';
import { 
  collection, 
  addDoc, 
  getDocs, 
  updateDoc, 
  deleteDoc, 
  doc,
  query,
  where,
  orderBy 
} from 'firebase/firestore';
import { 
  signInWithPopup, 
  GoogleAuthProvider, 
  signOut,
  onAuthStateChanged 
} from 'firebase/auth';

function App() {
  const [projects, setProjects] = useState([]);
  const [currentProject, setCurrentProject] = useState(null);
  const [projectDescription, setProjectDescription] = useState('');
  const [aiCommand, setAiCommand] = useState('');
  const [isGenerating, setIsGenerating] = useState(false);
  const [isProcessingCommand, setIsProcessingCommand] = useState(false);
  const [expandedNodes, setExpandedNodes] = useState(new Set());
  const [conversationHistory, setConversationHistory] = useState([]);
  const [viewMode, setViewMode] = useState('gantt');
  const [selectedTask, setSelectedTask] = useState(null);
  const [showXmlModal, setShowXmlModal] = useState(false);
  const [xmlContent, setXmlContent] = useState('');
  
  // Enhanced features state
  const [searchQuery, setSearchQuery] = useState('');
  const [statusFilter, setStatusFilter] = useState('all');
  const [priorityFilter, setPriorityFilter] = useState('all');
  const [showFilters, setShowFilters] = useState(false);
  
  // New PMP features
  const [ganttZoom, setGanttZoom] = useState(0.5); // Start compressed to show full schedule
  const [showAddTaskModal, setShowAddTaskModal] = useState(false);
  const [newTask, setNewTask] = useState({
    parentId: null,
    name: '',
    duration: 5,
    resources: '',
    cost: 0,
    priority: 'Medium',
    status: 'Not Started',
    riskLevel: 'Low',
    notes: ''
  });
  
  // Firebase auth state
  const [user, setUser] = useState(null);
  const [authLoading, setAuthLoading] = useState(true);

  // API configuration - switches between local development and production
  const isDevelopment = window.location.hostname === 'localhost' || 
                       window.location.hostname === '127.0.0.1';
  
  const API_PROXY = isDevelopment
    ? 'http://localhost:3001'
    : 'https://ai-scheduler-pvl1.onrender.com';

  // Initialize Firebase auth listener
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      setAuthLoading(false);
      if (currentUser) {
        loadProjects();
      } else {
        setProjects([]);
        setCurrentProject(null);
      }
    });
    
    return () => unsubscribe();
  }, []);

  // Load projects from Firestore
  const loadProjects = async () => {
    if (!user) return;

    try {
      const q = query(
        collection(db, 'projects'),
        where('userId', '==', user.uid),
        orderBy('createdAt', 'desc')
      );
      
      const querySnapshot = await getDocs(q);
      const loadedProjects = [];
      
      querySnapshot.forEach((docSnap) => {
        loadedProjects.push({
          ...docSnap.data(),
          firebaseId: docSnap.id,
          id: docSnap.id
        });
      });
      
      setProjects(loadedProjects);
      console.log('âœ… Loaded', loadedProjects.length, 'projects from Firestore');
    } catch (error) {
      console.error('Error loading projects:', error);
      alert('Error loading projects: ' + error.message);
    }
  };

  // Helper function to expand all nodes
  const expandAllNodes = (wbs) => {
    const expanded = new Set();
    const traverse = (nodes) => {
      nodes.forEach(node => {
        expanded.add(node.id);
        if (node.children && node.children.length > 0) {
          traverse(node.children);
        }
      });
    };
    traverse(wbs);
    return expanded;
  };

  // Auto-expand all nodes when project is set
  useEffect(() => {
    if (currentProject && currentProject.wbs) {
      const allExpanded = expandAllNodes(currentProject.wbs);
      setExpandedNodes(allExpanded);
    }
  }, [currentProject?.id]); // Only run when project changes

  // Save project to Firestore
  const saveProject = async (project) => {
    if (!user) {
      alert('Please sign in to save projects');
      return;
    }

    try {
      const projectData = {
        ...project,
        userId: user.uid,
        lastModified: new Date().toISOString()
      };

      const { firebaseId, ...dataToSave } = projectData;

      if (project.firebaseId) {
        await updateDoc(doc(db, 'projects', project.firebaseId), dataToSave);
        console.log('âœ… Updated project:', project.name);
      } else {
        const docRef = await addDoc(collection(db, 'projects'), dataToSave);
        project.firebaseId = docRef.id;
        project.id = docRef.id;
        console.log('âœ… Created new project:', project.name);
      }
      
      await loadProjects();
    } catch (error) {
      console.error('Error saving project:', error);
      alert('Failed to save project: ' + error.message);
    }
  };

  // Delete project from Firestore
  const deleteProject = async (projectId) => {
    if (!window.confirm('Are you sure you want to delete this project? This cannot be undone.')) {
      return;
    }

    try {
      const project = projects.find(p => p.id === projectId);
      if (project?.firebaseId) {
        await deleteDoc(doc(db, 'projects', project.firebaseId));
        console.log('âœ… Deleted project:', project.name);
      }
      await loadProjects();
    } catch (error) {
      console.error('Error deleting project:', error);
      alert('Failed to delete project: ' + error.message);
    }
  };

  // Firebase Authentication functions
  const signInWithGoogle = async () => {
    try {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
      console.log('âœ… Signed in successfully');
    } catch (error) {
      console.error('Error signing in:', error);
      alert('Failed to sign in: ' + error.message);
    }
  };

  const signOutUser = async () => {
    try {
      await signOut(auth);
      setCurrentProject(null);
      setProjects([]);
      console.log('âœ… Signed out successfully');
    } catch (error) {
      console.error('Error signing out:', error);
      alert('Failed to sign out: ' + error.message);
    }
  };

  // Get all tasks flattened from WBS tree
  const getAllTasks = (wbs) => {
    const tasks = [];
    const traverse = (nodes) => {
      nodes.forEach(node => {
        tasks.push(node);
        if (node.children && node.children.length > 0) {
          traverse(node.children);
        }
      });
    };
    if (wbs) traverse(wbs);
    return tasks;
  };

  // Smart filtering and search
  const filteredTasks = useMemo(() => {
    if (!currentProject?.wbs) return [];
    
    let tasks = getAllTasks(currentProject.wbs);
    
    if (searchQuery.trim()) {
      const query = searchQuery.toLowerCase();
      tasks = tasks.filter(task => 
        task.name.toLowerCase().includes(query) ||
        task.id.toLowerCase().includes(query) ||
        task.resources?.toLowerCase().includes(query) ||
        task.notes?.toLowerCase().includes(query)
      );
    }
    
    if (statusFilter !== 'all') {
      tasks = tasks.filter(task => task.status === statusFilter);
    }
    
    if (priorityFilter !== 'all') {
      tasks = tasks.filter(task => task.priority === priorityFilter);
    }
    
    return tasks;
  }, [currentProject, searchQuery, statusFilter, priorityFilter]);

  // Enhanced statistics with clickable navigation
  const projectStats = useMemo(() => {
    if (!currentProject?.wbs) return null;
    
    const allTasks = getAllTasks(currentProject.wbs);
    const totalTasks = allTasks.length;
    const completedTasks = allTasks.filter(t => t.status === 'Completed').length;
    const inProgressTasks = allTasks.filter(t => t.status === 'In Progress').length;
    const notStartedTasks = allTasks.filter(t => t.status === 'Not Started').length;
    const blockedTasks = allTasks.filter(t => t.status === 'Blocked').length;
    const onHoldTasks = allTasks.filter(t => t.status === 'On Hold').length;
    const highPriorityTasks = allTasks.filter(t => t.priority === 'High').length;
    const mediumPriorityTasks = allTasks.filter(t => t.priority === 'Medium').length;
    const lowPriorityTasks = allTasks.filter(t => t.priority === 'Low').length;
    const highRiskTasks = allTasks.filter(t => t.riskLevel === 'High').length;
    const totalCost = allTasks.reduce((sum, t) => sum + (t.cost || 0), 0);
    const avgProgress = totalTasks > 0 ? allTasks.reduce((sum, t) => sum + (t.progress || 0), 0) / totalTasks : 0;
    
    return {
      totalTasks,
      completedTasks,
      inProgressTasks,
      notStartedTasks,
      blockedTasks,
      onHoldTasks,
      highPriorityTasks,
      mediumPriorityTasks,
      lowPriorityTasks,
      highRiskTasks,
      totalCost,
      avgProgress: Math.round(avgProgress),
      completionRate: totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0
    };
  }, [currentProject]);

  // Handle status badge click
  const handleStatusClick = (status) => {
    setStatusFilter(status);
    setShowFilters(true);
    setViewMode('table');
  };

  const handlePriorityClick = (priority) => {
    setPriorityFilter(priority);
    setShowFilters(true);
    setViewMode('table');
  };

  const clearFilters = () => {
    setSearchQuery('');
    setStatusFilter('all');
    setPriorityFilter('all');
  };

  const processAICommand = async () => {
    if (!aiCommand.trim() || !currentProject) return;

    setIsProcessingCommand(true);

    try {
      // Check for quick action keywords first (no AI needed)
      const quickActions = {
        'mark all complete': () => {
          const markComplete = (nodes) => {
            return nodes.map(node => ({
              ...node,
              status: 'Completed',
              progress: 100,
              children: node.children ? markComplete(node.children) : []
            }));
          };
          return {
            ...currentProject,
            wbs: markComplete(currentProject.wbs)
          };
        },
        'reset all progress': () => {
          const resetProgress = (nodes) => {
            return nodes.map(node => ({
              ...node,
              status: 'Not Started',
              progress: 0,
              children: node.children ? resetProgress(node.children) : []
            }));
          };
          return {
            ...currentProject,
            wbs: resetProgress(currentProject.wbs)
          };
        },
        'increase all budgets 10%': () => {
          const increaseBudget = (nodes) => {
            return nodes.map(node => ({
              ...node,
              cost: Math.round((node.cost || 0) * 1.1),
              children: node.children ? increaseBudget(node.children) : []
            }));
          };
          return {
            ...currentProject,
            wbs: increaseBudget(currentProject.wbs),
            projectBudget: Math.round((currentProject.projectBudget || 0) * 1.1)
          };
        },
        'set all high priority': () => {
          const setHighPriority = (nodes) => {
            return nodes.map(node => ({
              ...node,
              priority: 'High',
              children: node.children ? setHighPriority(node.children) : []
            }));
          };
          return {
            ...currentProject,
            wbs: setHighPriority(currentProject.wbs)
          };
        }
      };

      // Check if this is a quick action
      const commandLower = aiCommand.toLowerCase().trim();
      const quickAction = quickActions[commandLower];
      
      if (quickAction) {
        const updatedProject = quickAction();
        updatedProject.lastModified = new Date().toISOString();
        await saveProject(updatedProject);
        setCurrentProject(updatedProject);
        setAiCommand('');
        setIsProcessingCommand(false);
        return;
      }

      const allHistory = [...conversationHistory];
      allHistory.push({
        role: 'user',
        content: aiCommand
      });

      // Enhanced PMP-aware prompt with stricter JSON requirements
      const response = await fetch(`${API_PROXY}/api/claude`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 8000,
          messages: [
            {
              role: 'user',
              content: `You are a PMP (Project Management Professional) expert. Modify this project based on the user's command.

CURRENT PROJECT JSON:
${JSON.stringify(currentProject, null, 2)}

USER COMMAND: "${aiCommand}"

CRITICAL INSTRUCTIONS:
1. Return VALID JSON ONLY - no markdown, no explanations, no text before or after
2. The JSON must be parseable by JSON.parse() - check for:
   - No trailing commas in arrays or objects
   - All strings in double quotes
   - All property names in double quotes
   - No comments in the JSON
3. Understand hierarchical commands like "add QC checks in phase 2" or "add safety review in phases 3, 4, and 5"
4. When adding tasks, create proper WBS IDs (e.g., if phase 2 has tasks 2.1-2.3, new task is 2.4)
5. Set realistic durations, costs, and resources based on task type
6. Maintain proper date sequencing
7. Keep ALL existing tasks unchanged unless specifically modified

Return the COMPLETE updated project JSON. Test it's valid JSON before returning.`
            }
          ],
        })
      });

      const data = await response.json();
      
      if (data.error) {
        throw new Error('API Error: ' + (data.error.message || 'Unknown error'));
      }

      const responseText = data.content?.find(block => block.type === 'text')?.text || '';
      
      if (!responseText) {
        throw new Error('No response from AI');
      }

      allHistory.push({
        role: 'assistant',
        content: responseText
      });

      // Aggressive JSON cleaning with multiple strategies
      let cleanedResponse = responseText.trim();
      
      // Remove markdown code blocks
      cleanedResponse = cleanedResponse.replace(/```json\s*/g, '');
      cleanedResponse = cleanedResponse.replace(/```\s*/g, '');
      cleanedResponse = cleanedResponse.replace(/`/g, '');
      
      // Find JSON boundaries
      const firstBrace = cleanedResponse.indexOf('{');
      const lastBrace = cleanedResponse.lastIndexOf('}');
      
      if (firstBrace === -1 || lastBrace === -1) {
        throw new Error('AI response does not contain valid JSON structure');
      }
      
      cleanedResponse = cleanedResponse.substring(firstBrace, lastBrace + 1);
      
      // Strategy 1: Fix common JSON syntax issues
      const fixJSON = (jsonStr) => {
        return jsonStr
          // Remove trailing commas before closing brackets/braces (multiple passes)
          .replace(/,(\s*[}\]])/g, '$1')
          .replace(/,(\s*[}\]])/g, '$1')
          .replace(/,(\s*[}\]])/g, '$1')
          // Fix common quote issues
          .replace(/(['"])?([a-zA-Z0-9_]+)(['"])?\s*:/g, '"$2":')
          // Remove comments
          .replace(/\/\/.*/g, '')
          .replace(/\/\*[\s\S]*?\*\//g, '')
          // Remove double commas
          .replace(/,\s*,/g, ',')
          // Remove leading commas
          .replace(/\[\s*,/g, '[')
          .replace(/{\s*,/g, '{')
          // Normalize whitespace
          .replace(/\n/g, ' ')
          .replace(/\s+/g, ' ')
          .trim();
      };
      
      // Try to parse with multiple strategies
      let updatedProject;
      let parseSuccess = false;
      const strategies = [
        // Strategy 1: Basic parsing
        () => JSON.parse(cleanedResponse),
        // Strategy 2: Single fix pass
        () => JSON.parse(fixJSON(cleanedResponse)),
        // Strategy 3: Multiple fix passes
        () => {
          let fixed = cleanedResponse;
          for (let i = 0; i < 3; i++) {
            fixed = fixJSON(fixed);
          }
          return JSON.parse(fixed);
        },
        // Strategy 4: Aggressive - fix arrays specifically
        () => {
          let fixed = fixJSON(cleanedResponse);
          // Fix array-specific issues
          fixed = fixed
            .replace(/,(\s*\])/g, '$1')  // Trailing comma in arrays
            .replace(/\],\s*\]/g, ']]')  // Double array closures
            .replace(/},\s*\]/g, '}]');  // Object followed by array close
          return JSON.parse(fixed);
        }
      ];
      
      for (let i = 0; i < strategies.length; i++) {
        try {
          updatedProject = strategies[i]();
          parseSuccess = true;
          if (i > 0) {
            console.log(`âœ… JSON parsed successfully using strategy ${i + 1}`);
          }
          break;
        } catch (e) {
          if (i === strategies.length - 1) {
            // All strategies failed
            console.error('JSON Parse Error:', e);
            console.error('Failed JSON preview:', cleanedResponse.substring(0, 500) + '...');
            throw new Error(
              `AI returned invalid JSON that couldn't be fixed automatically.\n\n` +
              `Error: ${e.message}\n\n` +
              `Try using these Quick Actions instead (just type them):\n` +
              `â€¢ "mark all complete"\n` +
              `â€¢ "reset all progress"\n` +
              `â€¢ "increase all budgets 10%"\n` +
              `â€¢ "set all high priority"\n\n` +
              `Or click the "Add Task" button for specific changes.`
            );
          }
        }
      }
      
      // Validate the structure
      if (!updatedProject.wbs || !Array.isArray(updatedProject.wbs)) {
        throw new Error('Invalid project structure - missing WBS array');
      }
      
      // Preserve Firebase IDs and metadata
      updatedProject.lastModified = new Date().toISOString();
      updatedProject.firebaseId = currentProject.firebaseId;
      updatedProject.id = currentProject.id;
      updatedProject.userId = currentProject.userId;
      updatedProject.createdAt = currentProject.createdAt;
      
      await saveProject(updatedProject);
      setCurrentProject(updatedProject);
      setConversationHistory(allHistory);
      setAiCommand('');
      
      // Success notification
      console.log('âœ… Project updated successfully!');
      
    } catch (error) {
      console.error('Error processing AI command:', error);
      
      // Better error messages
      let errorMessage = 'Error processing command:\n\n';
      if (error.message.includes('JSON') || error.message.includes('Quick Actions')) {
        errorMessage += error.message;
      } else if (error.message.includes('API')) {
        errorMessage += 'API connection issue. Check that:\n' +
                       'â€¢ Proxy server is running (npm run proxy)\n' +
                       'â€¢ You have internet connection\n' +
                       'â€¢ Your API key is valid';
      } else {
        errorMessage += error.message + '\n\nTry using:\n' +
                       'â€¢ Quick Actions (simple commands)\n' +
                       'â€¢ Manual Add Task button\n' +
                       'â€¢ Simpler, more specific requests';
      }
      
      alert(errorMessage);
    } finally {
      setIsProcessingCommand(false);
    }
  };

  const generateWBS = async () => {
    if (!projectDescription.trim()) return;
    if (!user) {
      alert('Please sign in to create projects');
      return;
    }

    setIsGenerating(true);
    const newHistory = [];

    try {
      console.log('ðŸš€ Starting WBS generation...');

      const response = await fetch(`${API_PROXY}/api/claude`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 4000,
          messages: [
            {
              role: 'user',
              content: `You are a PMP (Project Management Professional) expert. Create a comprehensive project plan with 4-5 phases and appropriate tasks for each phase.

Project: ${projectDescription}

Return ONLY this JSON structure with NO markdown, NO backticks, NO explanations:

{
  "projectName": "Project Name",
  "projectStart": "2025-01-20",
  "projectBudget": 200000,
  "projectManager": "Project Manager",
  "wbs": [
    {
      "id": "1",
      "name": "Phase 1",
      "level": 1,
      "duration": 15,
      "startDate": "2025-01-20",
      "endDate": "2025-02-04",
      "progress": 0,
      "resources": "Team",
      "cost": 50000,
      "priority": "High",
      "status": "Not Started",
      "dependencies": [],
      "riskLevel": "Medium",
      "notes": "Phase description",
      "children": [
        {"id": "1.1", "name": "Task 1", "level": 2, "duration": 5, "startDate": "2025-01-20", "endDate": "2025-01-25", "progress": 0, "resources": "Team Member", "cost": 10000, "priority": "High", "status": "Not Started", "dependencies": [], "riskLevel": "Low", "notes": "Task details", "children": []}
      ]
    }
  ]
}

Make 4-5 phases with 3-5 tasks each. Use realistic names, durations, and costs based on industry standards. Return ONLY pure JSON.`
            }
          ],
        })
      });

      const data = await response.json();
      
      if (data.error) {
        throw new Error('API Error: ' + (data.error.message || 'Unknown error'));
      }

      const responseText = data.content?.find(block => block.type === 'text')?.text || '';
      
      if (!responseText) {
        throw new Error('No response from AI');
      }

      newHistory.push({
        role: 'user',
        content: 'Generate WBS for: ' + projectDescription
      });
      newHistory.push({
        role: 'assistant',
        content: responseText
      });

      let cleanedResponse = responseText.trim();
      cleanedResponse = cleanedResponse.replace(/```json/g, '');
      cleanedResponse = cleanedResponse.replace(/```/g, '');
      cleanedResponse = cleanedResponse.replace(/`/g, '');
      
      const firstBrace = cleanedResponse.indexOf('{');
      const lastBrace = cleanedResponse.lastIndexOf('}');
      
      if (firstBrace === -1 || lastBrace === -1) {
        throw new Error('AI did not return valid JSON format');
      }
      
      cleanedResponse = cleanedResponse.substring(firstBrace, lastBrace + 1);

      const parsedData = JSON.parse(cleanedResponse);

      const newProject = {
        name: parsedData.projectName || 'Unnamed Project',
        description: projectDescription,
        projectStart: parsedData.projectStart || new Date().toISOString().split('T')[0],
        projectBudget: parsedData.projectBudget || 0,
        projectManager: parsedData.projectManager || 'Project Manager',
        wbs: parsedData.wbs || [],
        createdAt: new Date().toISOString(),
        lastModified: new Date().toISOString(),
        userId: user.uid
      };

      console.log('ðŸ’¾ Saving project to Firestore...');
      await saveProject(newProject);
      
      setCurrentProject(newProject);
      setConversationHistory(newHistory);
      setProjectDescription('');
      
      const newExpanded = new Set();
      const expandAll = (nodes) => {
        nodes.forEach(node => {
          newExpanded.add(node.id);
          if (node.children && node.children.length > 0) {
            expandAll(node.children);
          }
        });
      };
      expandAll(newProject.wbs);
      setExpandedNodes(newExpanded);

      console.log('âœ… Project created successfully!');
    } catch (error) {
      console.error('âŒ Error generating WBS:', error);
      alert('Error generating project: ' + error.message);
    } finally {
      setIsGenerating(false);
    }
  };

  const createTemplateProject = async (type) => {
    if (!user) {
      alert('Please sign in to create projects');
      return;
    }

    const templates = {
      construction: {
        name: '5-Story Office Building Construction with Underground Parking',
        description: 'Complete office building project with foundation, structure, MEP, and finishing',
        budget: 1900000,
        manager: 'Sarah Mitchell',
        phases: [
          { name: 'Planning and Design Phase', duration: 60, tasks: ['Architectural Design and Blueprints', 'Structural and MEP Engineering', 'Building Permits and Approvals'] },
          { name: 'Site Preparation and Excavation', duration: 30, tasks: ['Site Survey and Geotechnical Analysis', 'Demolition and Site Clearing', 'Excavation for Underground Parking'] },
          { name: 'Foundation and Underground Parking', duration: 45, tasks: ['Foundation Formwork and Rebar', 'Concrete Pour and Curing', 'Underground Parking Structure'] },
          { name: 'Structural and MEP Installation', duration: 90, tasks: ['Steel Framing and Floor Slabs', 'Electrical Rough-in and Main Panel', 'HVAC System Installation', 'Plumbing and Water Systems', 'Fire Safety and Security Systems'] },
          { name: 'Interior Finishing and Final Systems', duration: 60, tasks: ['Drywall and Ceiling Installation', 'Flooring and Tile Work', 'Interior Painting and Trim', 'Final Inspections and Certification'] }
        ]
      },
      software: {
        name: 'E-Commerce Mobile App',
        description: 'Full-stack mobile application with payment integration and admin panel',
        budget: 400000,
        manager: 'Mike Chen',
        phases: [
          { name: 'Planning & Design', duration: 15, tasks: ['Requirements Analysis', 'UI/UX Design', 'Architecture Design'] },
          { name: 'Backend Development', duration: 25, tasks: ['API Development', 'Database Setup', 'Authentication'] },
          { name: 'Frontend Development', duration: 25, tasks: ['React Native Setup', 'UI Components', 'API Integration'] },
          { name: 'Testing & QA', duration: 15, tasks: ['Unit Testing', 'Integration Testing', 'User Acceptance Testing'] },
          { name: 'Deployment', duration: 10, tasks: ['App Store Submission', 'Production Deployment', 'Monitoring Setup'] }
        ]
      },
      marketing: {
        name: 'Product Launch Campaign',
        description: 'Multi-channel marketing campaign for new product launch',
        budget: 150000,
        manager: 'Jennifer Smith',
        phases: [
          { name: 'Campaign Planning', duration: 10, tasks: ['Market Research', 'Target Audience Definition', 'Campaign Strategy'] },
          { name: 'Content Creation', duration: 20, tasks: ['Video Production', 'Social Media Content', 'Email Templates'] },
          { name: 'Channel Setup', duration: 15, tasks: ['Social Media Campaigns', 'Email Marketing Setup', 'Landing Pages'] },
          { name: 'Launch Execution', duration: 5, tasks: ['Campaign Go-Live', 'Initial Monitoring', 'Quick Adjustments'] },
          { name: 'Post-Launch', duration: 20, tasks: ['Performance Analysis', 'A/B Testing', 'Campaign Optimization'] }
        ]
      }
    };

    const template = templates[type];
    if (!template) return;

    const startDate = new Date();
    const wbs = [];
    let currentDate = new Date(startDate);
    let phaseId = 1;

    template.phases.forEach(phase => {
      const phaseStart = new Date(currentDate);
      const phaseEnd = new Date(phaseStart);
      phaseEnd.setDate(phaseEnd.getDate() + phase.duration);
      
      const children = [];
      const taskDuration = Math.floor(phase.duration / phase.tasks.length);
      let taskDate = new Date(phaseStart);
      
      phase.tasks.forEach((taskName, idx) => {
        const taskEnd = new Date(taskDate);
        taskEnd.setDate(taskEnd.getDate() + taskDuration);
        
        children.push({
          id: `${phaseId}.${idx + 1}`,
          name: taskName,
          level: 2,
          duration: taskDuration,
          startDate: taskDate.toISOString().split('T')[0],
          endDate: taskEnd.toISOString().split('T')[0],
          progress: 0,
          resources: 'Team Member',
          cost: Math.round(template.budget / (template.phases.length * phase.tasks.length)),
          priority: idx === 0 ? 'High' : 'Medium',
          status: 'Not Started',
          dependencies: [],
          riskLevel: 'Low',
          notes: `${taskName} for ${phase.name}`,
          children: []
        });
        
        taskDate = new Date(taskEnd);
      });
      
      wbs.push({
        id: phaseId.toString(),
        name: phase.name,
        level: 1,
        duration: phase.duration,
        startDate: phaseStart.toISOString().split('T')[0],
        endDate: phaseEnd.toISOString().split('T')[0],
        progress: 0,
        resources: 'Project Team',
        cost: Math.round(template.budget / template.phases.length),
        priority: 'High',
        status: 'Not Started',
        dependencies: phaseId > 1 ? [(phaseId - 1).toString()] : [],
        riskLevel: 'Medium',
        notes: phase.name,
        children: children
      });
      
      currentDate = new Date(phaseEnd);
      phaseId++;
    });

    const newProject = {
      name: template.name,
      description: template.description,
      projectStart: startDate.toISOString().split('T')[0],
      projectBudget: template.budget,
      projectManager: template.manager,
      wbs: wbs,
      createdAt: new Date().toISOString(),
      lastModified: new Date().toISOString(),
      userId: user.uid
    };

    await saveProject(newProject);
    setCurrentProject(newProject);
    
    const newExpanded = new Set();
    const expandAll = (nodes) => {
      nodes.forEach(node => {
        newExpanded.add(node.id);
        if (node.children && node.children.length > 0) {
          expandAll(node.children);
        }
      });
    };
    expandAll(newProject.wbs);
    setExpandedNodes(newExpanded);
  };

  // Manual add task functionality
  const addTaskManually = () => {
    if (!newTask.name.trim()) {
      alert('Please enter a task name');
      return;
    }

    const findParentAndAddTask = (nodes, parentId) => {
      for (let node of nodes) {
        if (node.id === parentId) {
          const newId = `${node.id}.${(node.children?.length || 0) + 1}`;
          const parentEnd = new Date(node.endDate);
          const taskStart = new Date(parentEnd);
          taskStart.setDate(taskStart.getDate() + 1);
          const taskEnd = new Date(taskStart);
          taskEnd.setDate(taskEnd.getDate() + parseInt(newTask.duration));
          
          const task = {
            id: newId,
            name: newTask.name,
            level: node.level + 1,
            duration: parseInt(newTask.duration),
            startDate: taskStart.toISOString().split('T')[0],
            endDate: taskEnd.toISOString().split('T')[0],
            progress: 0,
            resources: newTask.resources || 'Team Member',
            cost: parseFloat(newTask.cost) || 0,
            priority: newTask.priority,
            status: newTask.status,
            dependencies: [],
            riskLevel: newTask.riskLevel,
            notes: newTask.notes || '',
            children: []
          };
          
          if (!node.children) node.children = [];
          node.children.push(task);
          return true;
        }
        if (node.children && findParentAndAddTask(node.children, parentId)) {
          return true;
        }
      }
      return false;
    };

    const updatedProject = { ...currentProject };
    
    if (!newTask.parentId) {
      // Add as new phase
      const newPhaseId = (updatedProject.wbs.length + 1).toString();
      const lastPhase = updatedProject.wbs[updatedProject.wbs.length - 1];
      const phaseStart = lastPhase ? new Date(lastPhase.endDate) : new Date();
      if (lastPhase) phaseStart.setDate(phaseStart.getDate() + 1);
      const phaseEnd = new Date(phaseStart);
      phaseEnd.setDate(phaseEnd.getDate() + parseInt(newTask.duration));
      
      const newPhase = {
        id: newPhaseId,
        name: newTask.name,
        level: 1,
        duration: parseInt(newTask.duration),
        startDate: phaseStart.toISOString().split('T')[0],
        endDate: phaseEnd.toISOString().split('T')[0],
        progress: 0,
        resources: newTask.resources || 'Project Team',
        cost: parseFloat(newTask.cost) || 0,
        priority: newTask.priority,
        status: newTask.status,
        dependencies: lastPhase ? [lastPhase.id] : [],
        riskLevel: newTask.riskLevel,
        notes: newTask.notes || '',
        children: []
      };
      
      updatedProject.wbs.push(newPhase);
    } else {
      findParentAndAddTask(updatedProject.wbs, newTask.parentId);
    }
    
    updatedProject.lastModified = new Date().toISOString();
    setCurrentProject(updatedProject);
    saveProject(updatedProject);
    setShowAddTaskModal(false);
    setNewTask({
      parentId: null,
      name: '',
      duration: 5,
      resources: '',
      cost: 0,
      priority: 'Medium',
      status: 'Not Started',
      riskLevel: 'Low',
      notes: ''
    });
  };

  const getStatusColor = (status) => {
    const colors = {
      'Not Started': '#6b7280',
      'In Progress': '#3b82f6',
      'Completed': '#10b981',
      'On Hold': '#f59e0b',
      'Blocked': '#ef4444'
    };
    return colors[status] || '#6b7280';
  };

  const getPriorityColor = (priority) => {
    const colors = {
      'High': '#ef4444',
      'Medium': '#f59e0b',
      'Low': '#10b981'
    };
    return colors[priority] || '#6b7280';
  };

  const getRiskColor = (risk) => {
    const colors = {
      'High': '#ef4444',
      'Medium': '#f59e0b',
      'Low': '#10b981'
    };
    return colors[risk] || '#6b7280';
  };

  const calculateProjectDates = (wbs) => {
    if (!wbs || wbs.length === 0) return { start: new Date(), end: new Date() };
    
    let earliestDate = new Date(wbs[0].startDate);
    let latestDate = new Date(wbs[0].endDate);
    
    const checkDates = (nodes) => {
      nodes.forEach(node => {
        const start = new Date(node.startDate);
        const end = new Date(node.endDate);
        if (start < earliestDate) earliestDate = start;
        if (end > latestDate) latestDate = end;
        if (node.children && node.children.length > 0) {
          checkDates(node.children);
        }
      });
    };
    
    checkDates(wbs);
    return { start: earliestDate, end: latestDate };
  };

  const toggleNodeExpansion = (nodeId) => {
    const newExpanded = new Set(expandedNodes);
    if (newExpanded.has(nodeId)) {
      newExpanded.delete(nodeId);
    } else {
      newExpanded.add(nodeId);
    }
    setExpandedNodes(newExpanded);
  };

  const updateTaskField = (taskId, field, value) => {
    const updateNode = (nodes) => {
      return nodes.map(node => {
        if (node.id === taskId) {
          return { ...node, [field]: value };
        }
        if (node.children && node.children.length > 0) {
          return { ...node, children: updateNode(node.children) };
        }
        return node;
      });
    };

    const updatedProject = {
      ...currentProject,
      wbs: updateNode(currentProject.wbs),
      lastModified: new Date().toISOString()
    };

    setCurrentProject(updatedProject);
    saveProject(updatedProject);
  };

  const renderGanttView = () => {
    const projectDates = calculateProjectDates(currentProject.wbs);
    const totalDays = Math.ceil((projectDates.end - projectDates.start) / (1000 * 60 * 60 * 24)) + 1;
    const baseDayWidth = 50;
    const dayWidth = baseDayWidth * ganttZoom;

    const getTaskPosition = (task) => {
      const taskStart = new Date(task.startDate);
      const daysFromStart = Math.ceil((taskStart - projectDates.start) / (1000 * 60 * 60 * 24));
      return daysFromStart * dayWidth;
    };

    const getTaskWidth = (task) => {
      return Math.max(task.duration * dayWidth, 30);
    };

    const renderGanttRow = (node, depth = 0) => {
      const isExpanded = expandedNodes.has(node.id);
      const hasChildren = node.children && node.children.length > 0;
      const leftPosition = getTaskPosition(node);
      const barWidth = getTaskWidth(node);

      return (
        <React.Fragment key={node.id}>
          <div style={{ display: 'flex', borderBottom: '1px solid #e5e7eb' }}>
            <div style={{
              width: '400px',
              minWidth: '400px',
              padding: '0.75rem',
              paddingLeft: `${0.75 + depth * 1.5}rem`,
              display: 'flex',
              alignItems: 'center',
              background: node.level === 1 ? '#f9fafb' : 'white',
              borderRight: '2px solid #e5e7eb',
              height: '48px'
            }}>
              {hasChildren ? (
                <button
                  onClick={() => toggleNodeExpansion(node.id)}
                  style={{
                    background: 'none',
                    border: 'none',
                    cursor: 'pointer',
                    padding: 0,
                    marginRight: '0.5rem',
                    display: 'flex',
                    alignItems: 'center',
                    color: '#6b7280'
                  }}
                >
                  {isExpanded ? <ChevronDown size={16} /> : <ChevronRight size={16} />}
                </button>
              ) : (
                <span style={{ width: '24px', marginRight: '0.5rem' }}></span>
              )}
              <span style={{ 
                color: '#2563eb', 
                fontWeight: '700',
                marginRight: '0.75rem',
                fontFamily: 'monospace',
                fontSize: '0.875rem'
              }}>{node.id}</span>
              <span style={{ 
                fontWeight: node.level === 1 ? '700' : '500',
                fontSize: node.level === 1 ? '1rem' : '0.875rem',
                whiteSpace: 'nowrap',
                overflow: 'hidden',
                textOverflow: 'ellipsis'
              }}>{node.name}</span>
            </div>

            <div style={{
              flex: 1,
              position: 'relative',
              height: '48px',
              background: 'white'
            }}>
              <div
                style={{
                  position: 'absolute',
                  left: `${leftPosition}px`,
                  width: `${barWidth}px`,
                  height: '32px',
                  top: '8px',
                  background: getStatusColor(node.status),
                  borderRadius: '0.5rem',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                  transition: 'all 0.2s',
                  overflow: 'hidden'
                }}
                onClick={() => setSelectedTask(node)}
                title={`${node.name}\n${node.startDate} â†’ ${node.endDate}\n${node.progress}% complete`}
                onMouseEnter={(e) => {
                  e.currentTarget.style.transform = 'translateY(-2px)';
                  e.currentTarget.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.transform = 'translateY(0)';
                  e.currentTarget.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                }}
              >
                <div style={{
                  position: 'absolute',
                  left: 0,
                  top: 0,
                  height: '100%',
                  width: `${node.progress}%`,
                  background: 'rgba(255,255,255,0.3)',
                  transition: 'width 0.3s'
                }}></div>
                <span style={{
                  position: 'relative',
                  fontSize: '0.75rem',
                  fontWeight: '700',
                  color: 'white',
                  textShadow: '0 1px 2px rgba(0,0,0,0.3)',
                  zIndex: 1
                }}>{node.progress}%</span>
              </div>
            </div>
          </div>
          
          {isExpanded && hasChildren && node.children.map(child => renderGanttRow(child, depth + 1))}
        </React.Fragment>
      );
    };

    return (
      <div style={{
        background: 'white',
        borderRadius: '1rem',
        border: '2px solid #e5e7eb',
        overflow: 'hidden',
        boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
      }}>
        <div style={{
          display: 'flex',
          borderBottom: '2px solid #e5e7eb',
          background: 'linear-gradient(135deg, #1e40af 0%, #2563eb 100%)',
          color: 'white'
        }}>
          <div style={{
            width: '400px',
            minWidth: '400px',
            padding: '1rem',
            fontWeight: '700',
            fontSize: '0.875rem',
            borderRight: '2px solid rgba(255,255,255,0.2)'
          }}>
            Task
          </div>
          <div style={{
            flex: 1,
            overflowX: 'auto',
            display: 'flex',
            background: 'linear-gradient(135deg, #1e40af 0%, #2563eb 100%)'
          }}>
            {Array.from({ length: totalDays }, (_, i) => {
              const date = new Date(projectDates.start);
              date.setDate(date.getDate() + i);
              const dayName = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][date.getDay()];
              const isWeekend = date.getDay() === 0 || date.getDay() === 6;
              return (
                <div key={i} style={{
                  width: `${dayWidth}px`,
                  minWidth: `${dayWidth}px`,
                  textAlign: 'center',
                  padding: '0.5rem 0',
                  borderRight: '1px solid rgba(255,255,255,0.2)',
                  background: isWeekend ? 'rgba(0,0,0,0.1)' : 'transparent',
                  fontSize: '0.75rem',
                  fontWeight: '600'
                }}>
                  <div style={{ fontSize: '0.875rem', fontWeight: '700' }}>{date.getDate()}</div>
                  <div style={{ fontSize: '0.625rem', opacity: 0.8 }}>{date.getMonth() + 1}/{dayName}</div>
                </div>
              );
            })}
          </div>
        </div>

        <div style={{ 
          maxHeight: '600px', 
          overflowY: 'auto',
          position: 'relative'
        }}>
          <div style={{ 
            position: 'absolute', 
            top: 0, 
            left: '400px',
            right: 0,
            bottom: 0,
            display: 'flex',
            pointerEvents: 'none',
            zIndex: 0
          }}>
            {Array.from({ length: totalDays }, (_, i) => {
              const date = new Date(projectDates.start);
              date.setDate(date.getDate() + i);
              const isWeekend = date.getDay() === 0 || date.getDay() === 6;
              return (
                <div key={i} style={{
                  width: `${dayWidth}px`,
                  minWidth: `${dayWidth}px`,
                  borderRight: '1px solid #f3f4f6',
                  background: isWeekend ? '#fafafa' : 'transparent',
                  height: '100%'
                }} />
              );
            })}
          </div>
          
          <div style={{ position: 'relative', zIndex: 1 }}>
            {currentProject.wbs.map(task => renderGanttRow(task, 0))}
          </div>
        </div>
      </div>
    );
  };

  const renderTableView = () => {
    const allTasks = filteredTasks.length > 0 ? filteredTasks : getAllTasks(currentProject.wbs);

    return (
      <div className="table-view-container">
        <table className="table-view">
          <thead>
            <tr>
              <th>ID</th>
              <th>Task Name</th>
              <th>Status</th>
              <th>Priority</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Duration (days)</th>
              <th>Progress (%)</th>
              <th>Resources</th>
              <th>Cost ($)</th>
              <th>Risk Level</th>
            </tr>
          </thead>
          <tbody>
            {allTasks.map((task, idx) => (
              <tr key={task.id} className={`level-${task.level} ${idx % 2 === 0 ? 'even' : ''}`}>
                <td>{task.id}</td>
                <td>
                  <span style={{ paddingLeft: `${(task.level - 1) * 1.5}rem` }}>
                    {task.name}
                  </span>
                </td>
                <td>
                  <select
                    value={task.status}
                    onChange={(e) => updateTaskField(task.id, 'status', e.target.value)}
                    className="table-input"
                    style={{ backgroundColor: getStatusColor(task.status), color: 'white', fontWeight: 'bold' }}
                  >
                    <option value="Not Started">Not Started</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="On Hold">On Hold</option>
                    <option value="Blocked">Blocked</option>
                  </select>
                </td>
                <td>
                  <select
                    value={task.priority}
                    onChange={(e) => updateTaskField(task.id, 'priority', e.target.value)}
                    className="table-input"
                    style={{ color: getPriorityColor(task.priority), fontWeight: 'bold' }}
                  >
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                  </select>
                </td>
                <td>
                  <input
                    type="date"
                    value={task.startDate}
                    onChange={(e) => updateTaskField(task.id, 'startDate', e.target.value)}
                    className="table-input"
                  />
                </td>
                <td>
                  <input
                    type="date"
                    value={task.endDate}
                    onChange={(e) => updateTaskField(task.id, 'endDate', e.target.value)}
                    className="table-input"
                  />
                </td>
                <td className="text-center">{task.duration}</td>
                <td>
                  <input
                    type="number"
                    value={task.progress}
                    onChange={(e) => updateTaskField(task.id, 'progress', Math.min(100, Math.max(0, parseInt(e.target.value) || 0)))}
                    className="table-input"
                    min="0"
                    max="100"
                  />
                </td>
                <td>
                  <input
                    type="text"
                    value={task.resources}
                    onChange={(e) => updateTaskField(task.id, 'resources', e.target.value)}
                    className="table-input"
                  />
                </td>
                <td>
                  <input
                    type="number"
                    value={task.cost}
                    onChange={(e) => updateTaskField(task.id, 'cost', parseFloat(e.target.value) || 0)}
                    className="table-input"
                  />
                </td>
                <td>
                  <select
                    value={task.riskLevel}
                    onChange={(e) => updateTaskField(task.id, 'riskLevel', e.target.value)}
                    className="table-input"
                    style={{ color: getRiskColor(task.riskLevel), fontWeight: 'bold' }}
                  >
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                  </select>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    );
  };

  const renderWBSView = () => {
    const renderWBSNode = (node, depth = 0) => {
      const isExpanded = expandedNodes.has(node.id);
      const hasChildren = node.children && node.children.length > 0;

      // Visual indicators based on level
      const levelColors = {
        1: '#2563eb', // Blue for phases
        2: '#10b981', // Green for tasks
        3: '#f59e0b', // Orange for subtasks
        4: '#8b5cf6'  // Purple for sub-subtasks
      };
      
      const borderColor = levelColors[node.level] || '#6b7280';
      const bgColor = node.level === 1 ? '#f8fafc' : 'white';

      return (
        <div key={node.id} style={{ marginBottom: '0.75rem' }}>
          <div 
            className={`wbs-node-simple level-${node.level}`}
            style={{
              marginLeft: `${depth * 2}rem`,
              borderLeft: `4px solid ${borderColor}`,
              background: bgColor
            }}
          >
            {/* Header row with expand/collapse */}
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: '0.75rem',
              marginBottom: hasChildren && isExpanded ? '0.75rem' : '0'
            }}>
              {/* Expand/Collapse Button */}
              <button
                onClick={() => toggleNodeExpansion(node.id)}
                style={{
                  background: 'none',
                  border: 'none',
                  cursor: 'pointer',
                  padding: '0.25rem',
                  borderRadius: '0.25rem',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  width: '28px',
                  height: '28px',
                  flexShrink: 0,
                  transition: 'all 0.2s',
                  background: hasChildren ? '#f3f4f6' : 'transparent',
                  visibility: hasChildren ? 'visible' : 'hidden'
                }}
                onMouseEnter={(e) => {
                  if (hasChildren) e.currentTarget.style.background = '#e5e7eb';
                }}
                onMouseLeave={(e) => {
                  if (hasChildren) e.currentTarget.style.background = '#f3f4f6';
                }}
              >
                {hasChildren && (isExpanded ? <ChevronDown size={18} /> : <ChevronRight size={18} />)}
              </button>

              {/* Task ID and Name */}
              <div style={{ flex: 1, display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                <span style={{
                  fontFamily: 'monospace',
                  fontWeight: '700',
                  fontSize: '0.875rem',
                  color: borderColor,
                  minWidth: '3rem'
                }}>
                  {node.id}
                </span>
                <span style={{
                  fontWeight: node.level === 1 ? '700' : '600',
                  fontSize: node.level === 1 ? '1.125rem' : '1rem',
                  color: '#111827'
                }}>
                  {node.name}
                </span>
              </div>

              {/* Status and Priority badges */}
              <div style={{ display: 'flex', gap: '0.5rem', flexShrink: 0 }}>
                <span 
                  style={{
                    padding: '0.25rem 0.75rem',
                    borderRadius: '0.375rem',
                    fontSize: '0.75rem',
                    fontWeight: '600',
                    color: 'white',
                    background: getStatusColor(node.status)
                  }}
                >
                  {node.status}
                </span>
                <span 
                  style={{
                    padding: '0.25rem 0.75rem',
                    borderRadius: '0.375rem',
                    fontSize: '0.75rem',
                    fontWeight: '600',
                    color: 'white',
                    background: getPriorityColor(node.priority)
                  }}
                >
                  {node.priority}
                </span>
              </div>
            </div>

            {/* Details row */}
            <div style={{
              display: 'flex',
              flexWrap: 'wrap',
              gap: '1rem',
              marginTop: '0.5rem',
              paddingLeft: '3.25rem', // Align with name
              fontSize: '0.875rem',
              color: '#6b7280'
            }}>
              <span style={{ display: 'flex', alignItems: 'center', gap: '0.375rem' }}>
                <Calendar size={14} />
                {node.startDate} â†’ {node.endDate}
              </span>
              <span style={{ display: 'flex', alignItems: 'center', gap: '0.375rem' }}>
                <Clock size={14} />
                {node.duration} days
              </span>
              <span style={{ display: 'flex', alignItems: 'center', gap: '0.375rem' }}>
                <Users size={14} />
                {node.resources}
              </span>
              <span style={{ display: 'flex', alignItems: 'center', gap: '0.375rem' }}>
                <DollarSign size={14} />
                ${node.cost?.toLocaleString()}
              </span>
            </div>

            {/* Progress bar */}
            <div style={{
              marginTop: '0.75rem',
              marginLeft: '3.25rem',
              background: '#f3f4f6',
              borderRadius: '0.5rem',
              height: '6px',
              overflow: 'hidden'
            }}>
              <div style={{
                width: `${node.progress}%`,
                height: '100%',
                background: getStatusColor(node.status),
                transition: 'width 0.3s',
                borderRadius: '0.5rem'
              }} />
            </div>

            {/* Notes */}
            {node.notes && (
              <div style={{
                marginTop: '0.75rem',
                marginLeft: '3.25rem',
                padding: '0.75rem',
                background: '#fffbeb',
                border: '1px solid #fde047',
                borderRadius: '0.375rem',
                fontSize: '0.875rem',
                color: '#78350f'
              }}>
                ðŸ“ {node.notes}
              </div>
            )}
          </div>

          {/* Render children with connection line */}
          {isExpanded && hasChildren && (
            <div style={{
              marginTop: '0.5rem',
              marginLeft: `${depth * 2 + 1}rem`,
              borderLeft: `2px solid ${borderColor}20`, // 20 is alpha for transparency
              paddingLeft: '1rem'
            }}>
              {node.children.map(child => renderWBSNode(child, depth + 1))}
            </div>
          )}
        </div>
      );
    };

    return (
      <div className="wbs-view">
        <div style={{
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: '1.5rem',
          padding: '1rem',
          background: 'white',
          borderRadius: '0.75rem',
          border: '2px solid #e5e7eb'
        }}>
          <div>
            <h3 style={{ margin: 0, fontSize: '1.25rem', fontWeight: '700', color: '#111827' }}>
              Work Breakdown Structure
            </h3>
            <p style={{ margin: '0.25rem 0 0 0', fontSize: '0.875rem', color: '#6b7280' }}>
              Hierarchical view of all project tasks and phases
            </p>
          </div>
          <button
            onClick={() => {
              const allExpanded = expandAllNodes(currentProject.wbs);
              setExpandedNodes(allExpanded);
            }}
            style={{
              padding: '0.5rem 1rem',
              background: '#f3f4f6',
              border: '2px solid #e5e7eb',
              borderRadius: '0.5rem',
              cursor: 'pointer',
              fontSize: '0.875rem',
              fontWeight: '600',
              color: '#374151'
            }}
          >
            Expand All
          </button>
        </div>
        {currentProject.wbs.map(task => renderWBSNode(task, 0))}
      </div>
    );
  };

  // Loading state
  if (authLoading) {
    return (
      <div style={{
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        height: '100vh',
        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
      }}>
        <div style={{ textAlign: 'center', color: 'white' }}>
          <Loader2 size={48} className="spin" style={{ margin: '0 auto' }} />
          <p style={{ marginTop: '1rem', fontSize: '1.125rem' }}>Loading...</p>
        </div>
      </div>
    );
  }

  // Sign in page
  if (!user) {
    return (
      <div className="app">
        <header className="app-header">
          <div className="header-content">
            <div className="logo">
              <Sparkles size={32} />
              <div className="logo-text">
                <h1>AI Project Scheduler</h1>
                <span className="tagline">Intelligent Project Planning</span>
              </div>
            </div>
          </div>
        </header>
        
        <main style={{
          flex: 1,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '2rem'
        }}>
          <div style={{
            background: 'white',
            padding: '3rem',
            borderRadius: '1rem',
            boxShadow: '0 20px 50px rgba(0,0,0,0.3)',
            textAlign: 'center',
            maxWidth: '500px',
            width: '100%'
          }}>
            <div style={{ 
              width: '80px', 
              height: '80px', 
              margin: '0 auto 1.5rem',
              background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
              borderRadius: '1rem',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center'
            }}>
              <Sparkles size={48} style={{ color: 'white' }} />
            </div>
            
            <h2 style={{ fontSize: '2rem', marginBottom: '0.75rem', color: '#111827', fontWeight: '700' }}>
              Welcome Back!
            </h2>
            <p style={{ color: '#6b7280', marginBottom: '2rem', fontSize: '1.125rem', lineHeight: '1.6' }}>
              Sign in to access PMP-grade project management with AI
            </p>
            
            <button 
              onClick={signInWithGoogle}
              style={{
                width: '100%',
                padding: '1rem',
                background: 'linear-gradient(135deg, #2563eb 0%, #1e40af 100%)',
                color: 'white',
                border: 'none',
                borderRadius: '0.75rem',
                fontSize: '1.125rem',
                fontWeight: '600',
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                gap: '0.75rem',
                boxShadow: '0 4px 12px rgba(37, 99, 235, 0.3)',
                transition: 'all 0.2s'
              }}
            >
              <svg width="24" height="24" viewBox="0 0 24 24">
                <path fill="white" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="white" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="white" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="white" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
              </svg>
              Sign in with Google
            </button>
          </div>
        </main>
      </div>
    );
  }

  // Main app UI
  return (
    <div className="app">
      <header className="app-header">
        <div className="header-content">
          <div className="header-left">
            <div className="logo">
              <Sparkles size={32} />
              <div className="logo-text">
                <h1>AI Project Scheduler</h1>
                <span className="tagline">Intelligent Project Planning</span>
              </div>
            </div>
            {currentProject && (
              <div className="project-info-header">
                <div className="project-name-large">{currentProject.name}</div>
                <div className="project-meta">
                  <span><Calendar size={14} /> {currentProject.projectStart}</span>
                  <span><DollarSign size={14} /> ${currentProject.projectBudget?.toLocaleString()}</span>
                  <span><Users size={14} /> {currentProject.projectManager}</span>
                </div>
              </div>
            )}
          </div>
          
          <div style={{ display: 'flex', gap: '1rem', alignItems: 'center' }}>
            <div style={{ 
              display: 'flex', 
              alignItems: 'center', 
              gap: '0.75rem',
              padding: '0.5rem 1rem',
              background: 'rgba(255,255,255,0.1)',
              borderRadius: '0.5rem'
            }}>
              {user.photoURL && (
                <img 
                  src={user.photoURL} 
                  alt="Profile" 
                  referrerPolicy="no-referrer"
                  style={{ 
                    width: '32px', 
                    height: '32px', 
                    borderRadius: '50%',
                    border: '2px solid white'
                  }} 
                />
              )}
              <span style={{ color: 'white', fontSize: '0.875rem', fontWeight: '500' }}>
                {user.displayName || user.email}
              </span>
            </div>
            
            <button 
              onClick={signOutUser}
              style={{
                padding: '0.75rem 1.25rem',
                background: 'rgba(255,255,255,0.2)',
                color: 'white',
                border: 'none',
                borderRadius: '0.5rem',
                cursor: 'pointer',
                fontWeight: '600',
                fontSize: '0.875rem',
                display: 'flex',
                alignItems: 'center',
                gap: '0.5rem',
                transition: 'all 0.2s'
              }}
            >
              <LogOut size={16} />
              Sign Out
            </button>
          </div>
        </div>
      </header>

      {currentProject && (
        <>
          {/* Integrated Filters & Stats Panel */}
          {showFilters && (
            <div style={{ 
              background: 'white', 
              borderBottom: '2px solid #e5e7eb',
              padding: '1.5rem 2rem'
            }}>
              {/* Search and Filters */}
              <div style={{ display: 'flex', gap: '1rem', marginBottom: '1.5rem', flexWrap: 'wrap' }}>
                <div style={{ flex: 1, minWidth: '250px', position: 'relative' }}>
                  <Search size={18} style={{ position: 'absolute', left: '0.75rem', top: '50%', transform: 'translateY(-50%)', color: '#6b7280' }} />
                  <input
                    type="text"
                    placeholder="Search tasks, resources, notes..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    style={{
                      width: '100%',
                      padding: '0.625rem 0.625rem 0.625rem 2.5rem',
                      border: '2px solid #e5e7eb',
                      borderRadius: '0.5rem',
                      fontSize: '0.875rem'
                    }}
                  />
                </div>
                
                <select
                  value={statusFilter}
                  onChange={(e) => setStatusFilter(e.target.value)}
                  style={{
                    padding: '0.625rem 1rem',
                    border: '2px solid #e5e7eb',
                    borderRadius: '0.5rem',
                    fontSize: '0.875rem',
                    fontWeight: '600'
                  }}
                >
                  <option value="all">All Statuses</option>
                  <option value="Not Started">Not Started</option>
                  <option value="In Progress">In Progress</option>
                  <option value="Completed">Completed</option>
                  <option value="On Hold">On Hold</option>
                  <option value="Blocked">Blocked</option>
                </select>

                <select
                  value={priorityFilter}
                  onChange={(e) => setPriorityFilter(e.target.value)}
                  style={{
                    padding: '0.625rem 1rem',
                    border: '2px solid #e5e7eb',
                    borderRadius: '0.5rem',
                    fontSize: '0.875rem',
                    fontWeight: '600'
                  }}
                >
                  <option value="all">All Priorities</option>
                  <option value="High">High Priority</option>
                  <option value="Medium">Medium Priority</option>
                  <option value="Low">Low Priority</option>
                </select>

                {(searchQuery || statusFilter !== 'all' || priorityFilter !== 'all') && (
                  <button
                    onClick={clearFilters}
                    style={{
                      padding: '0.625rem 1rem',
                      background: '#f3f4f6',
                      border: 'none',
                      borderRadius: '0.5rem',
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.5rem',
                      fontWeight: '600',
                      fontSize: '0.875rem'
                    }}
                  >
                    <X size={16} />
                    Clear
                  </button>
                )}
              </div>

              {/* Stats Grid */}
              {projectStats && (
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
                  gap: '1rem'
                }}>
                  <div className="stat-card-small" onClick={() => handleStatusClick('all')} style={{ cursor: 'pointer' }}>
                    <BarChart3 size={20} style={{ color: '#3b82f6' }} />
                    <div>
                      <div style={{ fontSize: '0.75rem', color: '#6b7280', fontWeight: '600' }}>Total Tasks</div>
                      <div style={{ fontSize: '1.5rem', fontWeight: '700', color: '#111827' }}>{projectStats.totalTasks}</div>
                    </div>
                  </div>

                  <div className="stat-card-small" onClick={() => handleStatusClick('Completed')} style={{ cursor: 'pointer' }}>
                    <CheckCircle size={20} style={{ color: '#10b981' }} />
                    <div>
                      <div style={{ fontSize: '0.75rem', color: '#6b7280', fontWeight: '600' }}>Completed</div>
                      <div style={{ fontSize: '1.5rem', fontWeight: '700', color: '#10b981' }}>{projectStats.completedTasks}</div>
                    </div>
                  </div>

                  <div className="stat-card-small" onClick={() => handleStatusClick('In Progress')} style={{ cursor: 'pointer' }}>
                    <Play size={20} style={{ color: '#3b82f6' }} />
                    <div>
                      <div style={{ fontSize: '0.75rem', color: '#6b7280', fontWeight: '600' }}>In Progress</div>
                      <div style={{ fontSize: '1.5rem', fontWeight: '700', color: '#3b82f6' }}>{projectStats.inProgressTasks}</div>
                    </div>
                  </div>

                  <div className="stat-card-small" onClick={() => handleStatusClick('Not Started')} style={{ cursor: 'pointer' }}>
                    <Pause size={20} style={{ color: '#6b7280' }} />
                    <div>
                      <div style={{ fontSize: '0.75rem', color: '#6b7280', fontWeight: '600' }}>Not Started</div>
                      <div style={{ fontSize: '1.5rem', fontWeight: '700', color: '#6b7280' }}>{projectStats.notStartedTasks}</div>
                    </div>
                  </div>

                  {projectStats.blockedTasks > 0 && (
                    <div className="stat-card-small" onClick={() => handleStatusClick('Blocked')} style={{ cursor: 'pointer' }}>
                      <AlertTriangle size={20} style={{ color: '#ef4444' }} />
                      <div>
                        <div style={{ fontSize: '0.75rem', color: '#6b7280', fontWeight: '600' }}>Blocked</div>
                        <div style={{ fontSize: '1.5rem', fontWeight: '700', color: '#ef4444' }}>{projectStats.blockedTasks}</div>
                      </div>
                    </div>
                  )}

                  <div className="stat-card-small" onClick={() => handlePriorityClick('High')} style={{ cursor: 'pointer' }}>
                    <AlertTriangle size={20} style={{ color: '#ef4444' }} />
                    <div>
                      <div style={{ fontSize: '0.75rem', color: '#6b7280', fontWeight: '600' }}>High Priority</div>
                      <div style={{ fontSize: '1.5rem', fontWeight: '700', color: '#ef4444' }}>{projectStats.highPriorityTasks}</div>
                    </div>
                  </div>

                  <div className="stat-card-small">
                    <TrendingUp size={20} style={{ color: '#8b5cf6' }} />
                    <div>
                      <div style={{ fontSize: '0.75rem', color: '#6b7280', fontWeight: '600' }}>Avg Progress</div>
                      <div style={{ fontSize: '1.5rem', fontWeight: '700', color: '#8b5cf6' }}>{projectStats.avgProgress}%</div>
                    </div>
                  </div>

                  <div className="stat-card-small">
                    <DollarSign size={20} style={{ color: '#f59e0b' }} />
                    <div>
                      <div style={{ fontSize: '0.75rem', color: '#6b7280', fontWeight: '600' }}>Total Cost</div>
                      <div style={{ fontSize: '1.5rem', fontWeight: '700', color: '#f59e0b' }}>${(projectStats.totalCost / 1000).toFixed(0)}k</div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}

          <div className="toolbar">
            <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
              <div className="view-buttons">
                <button
                  onClick={() => setViewMode('gantt')}
                  className={`btn-view ${viewMode === 'gantt' ? 'active' : ''}`}
                >
                  <BarChart3 size={16} />
                  Gantt Chart
                </button>
                <button
                  onClick={() => setViewMode('table')}
                  className={`btn-view ${viewMode === 'table' ? 'active' : ''}`}
                >
                  <Table2 size={16} />
                  Table View
                </button>
                <button
                  onClick={() => setViewMode('wbs')}
                  className={`btn-view ${viewMode === 'wbs' ? 'active' : ''}`}
                >
                  <Grid3x3 size={16} />
                  WBS View
                </button>
              </div>
              
              {/* Add Task button - moved to left for better proximity */}
              <button
                onClick={() => setShowAddTaskModal(true)}
                className="btn-add"
                style={{ marginLeft: '0.5rem' }}
              >
                <Plus size={16} />
                Add Task
              </button>
            </div>

            <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
              {viewMode === 'gantt' && (
                <div style={{ display: 'flex', gap: '0.25rem', marginRight: '0.5rem' }}>
                  <button
                    onClick={() => setGanttZoom(Math.max(0.25, ganttZoom - 0.25))}
                    className="btn-icon"
                    title="Zoom Out - Compress Timeline"
                  >
                    <ZoomOut size={16} />
                  </button>
                  <button
                    onClick={() => setGanttZoom(0.5)}
                    className="btn-icon"
                    title="Full Schedule View"
                    style={{ 
                      background: ganttZoom === 0.5 ? '#dbeafe' : 'white',
                      borderColor: ganttZoom === 0.5 ? '#3b82f6' : '#e5e7eb'
                    }}
                  >
                    <Maximize2 size={16} />
                  </button>
                  <button
                    onClick={() => setGanttZoom(Math.min(2, ganttZoom + 0.25))}
                    className="btn-icon"
                    title="Zoom In - Detailed View"
                  >
                    <ZoomIn size={16} />
                  </button>
                  <span style={{
                    marginLeft: '0.5rem',
                    fontSize: '0.75rem',
                    color: '#6b7280',
                    fontWeight: '600',
                    minWidth: '4rem'
                  }}>
                    {ganttZoom === 0.25 && 'Very Wide'}
                    {ganttZoom === 0.5 && 'Full View'}
                    {ganttZoom === 0.75 && 'Wide'}
                    {ganttZoom === 1 && 'Normal'}
                    {ganttZoom === 1.25 && 'Detailed'}
                    {ganttZoom === 1.5 && 'Very Detailed'}
                    {ganttZoom === 1.75 && 'Ultra Detailed'}
                    {ganttZoom === 2 && 'Maximum'}
                  </span>
                </div>
              )}
              
              <button
                onClick={() => setShowFilters(!showFilters)}
                className={`btn-view ${showFilters ? 'active' : ''}`}
              >
                <Filter size={16} />
                Filters
              </button>
              
              <button
                onClick={() => setCurrentProject(null)}
                className="btn-close"
              >
                Close Project
              </button>
            </div>
          </div>
        </>
      )}

      <main className="main-content">
        {!currentProject ? (
          <div className="project-setup">
            <div className="setup-card">
              <div className="setup-header">
                <Sparkles className="sparkle-icon" size={48} />
                <div>
                  <h2>Create Your Project Plan</h2>
                  <p className="setup-subtitle">
                    Choose a template or describe your project and let AI create a comprehensive plan
                  </p>
                </div>
              </div>

              <div className="templates">
                <h3>ðŸš€ Quick Start Templates</h3>
                <div className="template-grid">
                  <button
                    onClick={() => createTemplateProject('construction')}
                    className="template-btn"
                  >
                    <div className="template-icon">ðŸ—ï¸</div>
                    <div className="template-title">Office Building Construction</div>
                    <div className="template-desc">Complete construction project with 5 phases</div>
                  </button>
                  <button
                    onClick={() => createTemplateProject('software')}
                    className="template-btn"
                  >
                    <div className="template-icon">ðŸ’»</div>
                    <div className="template-title">E-Commerce Mobile App</div>
                    <div className="template-desc">Full development lifecycle with 5 phases</div>
                  </button>
                  <button
                    onClick={() => createTemplateProject('marketing')}
                    className="template-btn"
                  >
                    <div className="template-icon">ðŸš€</div>
                    <div className="template-title">Product Launch Campaign</div>
                    <div className="template-desc">Marketing campaign with 5 phases</div>
                  </button>
                </div>
              </div>
              
              <div className="form-group" style={{marginTop: '2rem'}}>
                <label>Or Create Custom Project with AI</label>
                <textarea
                  value={projectDescription}
                  onChange={(e) => setProjectDescription(e.target.value)}
                  placeholder="Describe your project in detail... Example: 'Build a 5-story office building with underground parking, complete with HVAC, electrical, and interior finishing'"
                  rows="4"
                />
              </div>

              <button
                onClick={generateWBS}
                disabled={isGenerating || !projectDescription.trim()}
                className="btn-generate"
              >
                {isGenerating ? (
                  <>
                    <Loader2 className="spin" size={22} />
                    AI is creating your project...
                  </>
                ) : (
                  <>
                    <Sparkles size={22} />
                    Generate Custom Project with AI
                  </>
                )}
              </button>
            </div>

            {projects.length > 0 && (
              <div className="projects-list">
                <h3>ðŸ“ Your Projects ({projects.length})</h3>
                <div className="projects-grid">
                  {projects.map(project => (
                    <div key={project.id} className="project-card">
                      <div className="project-card-header">
                        <h4>{project.name}</h4>
                        <span className="project-badge">{project.wbs?.length || 0} Phases</span>
                      </div>
                      <p className="project-description">{project.description}</p>
                      <div className="project-card-footer">
                        <div className="project-meta-small">
                          <span><Calendar size={14} /> {new Date(project.createdAt).toLocaleDateString()}</span>
                          {project.projectBudget && (
                            <span><DollarSign size={14} /> ${project.projectBudget.toLocaleString()}</span>
                          )}
                        </div>
                        <div className="project-actions">
                          <button
                            onClick={() => {
                              setCurrentProject(project);
                              const newExpanded = new Set();
                              const expandAll = (nodes) => {
                                nodes.forEach(node => {
                                  newExpanded.add(node.id);
                                  if (node.children && node.children.length > 0) {
                                    expandAll(node.children);
                                  }
                                });
                              };
                              expandAll(project.wbs);
                              setExpandedNodes(newExpanded);
                            }}
                            className="btn-open"
                          >
                            Open Project
                          </button>
                          <button
                            onClick={() => deleteProject(project.id)}
                            className="btn-delete-icon"
                          >
                            <Trash2 size={16} />
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        ) : (
          <div className="project-view">
            <div className="ai-assistant">
              <div className="ai-header">
                <Sparkles size={20} />
                <label>PMP AI Assistant - Natural Language Commands</label>
              </div>
              <div className="ai-input-group">
                <input
                  type="text"
                  value={aiCommand}
                  onChange={(e) => setAiCommand(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && processAICommand()}
                  placeholder="Example: 'Add QC checks in phase 2' or 'Add safety review in phases 3, 4, and 5'"
                />
                <button
                  onClick={processAICommand}
                  disabled={isProcessingCommand || !aiCommand.trim()}
                  className="btn-ai"
                >
                  {isProcessingCommand ? (
                    <Loader2 className="spin" size={20} />
                  ) : (
                    <Sparkles size={20} />
                  )}
                </button>
              </div>
              <div className="ai-suggestions">
                <strong>Try these PMP commands:</strong>
                <button onClick={() => setAiCommand("Add quality control checkpoints to all phases")} className="suggestion-chip">Add QC checkpoints</button>
                <button onClick={() => setAiCommand("Add safety review tasks to phases 3, 4, and 5")} className="suggestion-chip">Add safety reviews</button>
                <button onClick={() => setAiCommand("Create milestone markers for each phase completion")} className="suggestion-chip">Add milestones</button>
                <button onClick={() => setAiCommand("Add resource leveling for overallocated tasks")} className="suggestion-chip">Level resources</button>
              </div>
            </div>

            {viewMode === 'gantt' && renderGanttView()}
            {viewMode === 'table' && renderTableView()}
            {viewMode === 'wbs' && renderWBSView()}
          </div>
        )}
      </main>

      {/* Add Task Modal */}
      {showAddTaskModal && (
        <div className="modal-overlay">
          <div className="modal" style={{ maxWidth: '600px' }}>
            <div className="modal-header">
              <h3>Add New Task/Phase</h3>
              <button onClick={() => setShowAddTaskModal(false)} className="modal-close">
                Ã—
              </button>
            </div>
            
            <div className="modal-body">
              <div className="form-group">
                <label>Parent Task (leave empty for new phase)</label>
                <select
                  value={newTask.parentId || ''}
                  onChange={(e) => setNewTask({...newTask, parentId: e.target.value || null})}
                  style={{
                    width: '100%',
                    padding: '0.625rem',
                    border: '2px solid #e5e7eb',
                    borderRadius: '0.5rem',
                    fontSize: '0.875rem'
                  }}
                >
                  <option value="">-- New Phase --</option>
                  {getAllTasks(currentProject.wbs).map(task => (
                    <option key={task.id} value={task.id}>
                      {' '.repeat((task.level - 1) * 2)}{task.id} {task.name}
                    </option>
                  ))}
                </select>
              </div>

              <div className="form-group">
                <label>Task Name *</label>
                <input
                  type="text"
                  value={newTask.name}
                  onChange={(e) => setNewTask({...newTask, name: e.target.value})}
                  placeholder="Enter task name"
                  style={{
                    width: '100%',
                    padding: '0.625rem',
                    border: '2px solid #e5e7eb',
                    borderRadius: '0.5rem',
                    fontSize: '0.875rem'
                  }}
                />
              </div>

              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                <div className="form-group">
                  <label>Duration (days)</label>
                  <input
                    type="number"
                    value={newTask.duration}
                    onChange={(e) => setNewTask({...newTask, duration: e.target.value})}
                    min="1"
                    style={{
                      width: '100%',
                      padding: '0.625rem',
                      border: '2px solid #e5e7eb',
                      borderRadius: '0.5rem',
                      fontSize: '0.875rem'
                    }}
                  />
                </div>

                <div className="form-group">
                  <label>Cost ($)</label>
                  <input
                    type="number"
                    value={newTask.cost}
                    onChange={(e) => setNewTask({...newTask, cost: e.target.value})}
                    min="0"
                    style={{
                      width: '100%',
                      padding: '0.625rem',
                      border: '2px solid #e5e7eb',
                      borderRadius: '0.5rem',
                      fontSize: '0.875rem'
                    }}
                  />
                </div>
              </div>

              <div className="form-group">
                <label>Resources</label>
                <input
                  type="text"
                  value={newTask.resources}
                  onChange={(e) => setNewTask({...newTask, resources: e.target.value})}
                  placeholder="e.g., Project Manager, Team Lead"
                  style={{
                    width: '100%',
                    padding: '0.625rem',
                    border: '2px solid #e5e7eb',
                    borderRadius: '0.5rem',
                    fontSize: '0.875rem'
                  }}
                />
              </div>

              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '1rem' }}>
                <div className="form-group">
                  <label>Priority</label>
                  <select
                    value={newTask.priority}
                    onChange={(e) => setNewTask({...newTask, priority: e.target.value})}
                    style={{
                      width: '100%',
                      padding: '0.625rem',
                      border: '2px solid #e5e7eb',
                      borderRadius: '0.5rem',
                      fontSize: '0.875rem'
                    }}
                  >
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                  </select>
                </div>

                <div className="form-group">
                  <label>Status</label>
                  <select
                    value={newTask.status}
                    onChange={(e) => setNewTask({...newTask, status: e.target.value})}
                    style={{
                      width: '100%',
                      padding: '0.625rem',
                      border: '2px solid #e5e7eb',
                      borderRadius: '0.5rem',
                      fontSize: '0.875rem'
                    }}
                  >
                    <option value="Not Started">Not Started</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="On Hold">On Hold</option>
                    <option value="Blocked">Blocked</option>
                  </select>
                </div>

                <div className="form-group">
                  <label>Risk Level</label>
                  <select
                    value={newTask.riskLevel}
                    onChange={(e) => setNewTask({...newTask, riskLevel: e.target.value})}
                    style={{
                      width: '100%',
                      padding: '0.625rem',
                      border: '2px solid #e5e7eb',
                      borderRadius: '0.5rem',
                      fontSize: '0.875rem'
                    }}
                  >
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                  </select>
                </div>
              </div>

              <div className="form-group">
                <label>Notes</label>
                <textarea
                  value={newTask.notes}
                  onChange={(e) => setNewTask({...newTask, notes: e.target.value})}
                  placeholder="Additional notes..."
                  rows="3"
                  style={{
                    width: '100%',
                    padding: '0.625rem',
                    border: '2px solid #e5e7eb',
                    borderRadius: '0.5rem',
                    fontSize: '0.875rem',
                    fontFamily: 'inherit'
                  }}
                />
              </div>
            </div>

            <div className="modal-footer">
              <button onClick={() => setShowAddTaskModal(false)} className="btn-secondary">
                Cancel
              </button>
              <button onClick={addTaskManually} className="btn-primary">
                <Plus size={16} />
                Add Task
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

export default App;